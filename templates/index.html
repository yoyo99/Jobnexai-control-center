<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>JobNexAI Control Center</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background: #050816; color: #e5e7eb; }
    header { padding: 16px 24px; border-bottom: 1px solid #111827; display: flex; justify-content: space-between; align-items: center; background: radial-gradient(circle at top left, #1d4ed8 0, #020617 45%); }
    h1 { margin: 0; font-size: 1.4rem; color: #e5e7eb; }
    .subtitle { font-size: 0.85rem; color: #9ca3af; }
    main { padding: 20px 24px 40px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card { border-radius: 12px; border: 1px solid #111827; background: linear-gradient(145deg, #020617, #020617, #020617); padding: 14px 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .card-title { font-size: 0.95rem; font-weight: 600; }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 0.7rem; }
    .badge-ok { background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.4); }
    .badge-ko { background: rgba(248,113,113,0.15); color: #fca5a5; border: 1px solid rgba(248,113,113,0.4); }
    .badge-unknown { background: rgba(148,163,184,0.15); color: #cbd5f5; border: 1px solid rgba(148,163,184,0.4); }
    pre { background: #020617; border-radius: 8px; padding: 8px; font-size: 0.75rem; max-height: 180px; overflow: auto; border: 1px solid #111827; }
    button { padding: 6px 10px; border-radius: 999px; border: 1px solid #1d4ed8; background: #1d4ed8; color: #e5e7eb; font-size: 0.8rem; cursor: pointer; }
    button.secondary { background: transparent; border-color: #374151; color: #9ca3af; }
    button:hover { filter: brightness(1.1); }
    input, select { width: 100%; padding: 8px 10px; border-radius: 999px; border: 1px solid #1f2937; background: #020617; color: #e5e7eb; font-size: 0.85rem; }
    .section-title { font-size: 1rem; font-weight: 600; margin: 16px 0 8px; color: #e5e7eb; }
    .toolbar-right { display: flex; gap: 8px; align-items: center; }
    .pill { font-size: 0.75rem; padding: 4px 10px; border-radius: 999px; border: 1px solid #1f2937; color: #9ca3af; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>JobNexAI Control Center</h1>
      <div class="subtitle">Vue d’ensemble des services IA & outils JobNexAI</div>
    </div>
    <div class="toolbar-right">
      <span class="pill" id="lastRefresh">Dernier refresh : jamais</span>
      <button class="secondary" onclick="refreshStatus()">Rafraîchir le statut</button>
    </div>
  </header>

  <main>
    <div class="section-title">Statut des services</div>
    <div class="grid" id="servicesGrid"></div>

    <div class="section-title">Ollama — Prompt rapide</div>
    <div class="card">
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <select id="ollamaModel"></select>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input id="ollamaPrompt" placeholder="Ton prompt pour Ollama..." />
        <button onclick="sendOllama()">Envoyer</button>
      </div>

      <pre id="ollamaResponse">En attente d’un prompt…</pre>
    </div>
  </main>

  <script>
    const serviceOrder = [
      "ollama",
      "vibe",
      "claude",
      "openai",
      "n8n",
      "firecrawl",
      "browser_mcp"
    ];

    function badgeClass(ok) {
      if (ok === true) return "badge badge-ok";
      if (ok === false) return "badge badge-ko";
      return "badge badge-unknown";
    }

    function badgeLabel(ok) {
      if (ok === true) return "OK";
      if (ok === false) return "KO";
      return "Inconnu";
    }

    async function refreshStatus() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();
        const grid = document.getElementById('servicesGrid');
        grid.innerHTML = '';

        // Remplir la liste des modèles Ollama
        if (data.ollama?.details?.models) {
          const select = document.getElementById('ollamaModel');
          select.innerHTML = "";
          data.ollama.details.models.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.name;
            opt.textContent = m.name;
            select.appendChild(opt);
          });
        }

        serviceOrder.forEach(key => {
          const svc = data[key] || { ok: null, error: "Non testé" };
          const card = document.createElement('div');
          card.className = 'card';

          card.innerHTML = `
            <div class="card-header">
              <div class="card-title">${key}</div>
              <span class="${badgeClass(svc.ok)}">${badgeLabel(svc.ok)}</span>
            </div>
            <pre>${JSON.stringify(svc, null, 2)}</pre>
          `;
          grid.appendChild(card);
        });

        document.getElementById('lastRefresh').textContent =
          'Dernier refresh : ' + new Date().toLocaleTimeString();
      } catch (e) {
        console.error(e);
      }
    }

    async function sendOllama() {
      const prompt = document.getElementById('ollamaPrompt').value;
      const model = document.getElementById('ollamaModel').value;

      if (!prompt.trim()) return;

      document.getElementById('ollamaResponse').textContent = 'Génération en cours…';

      try {
        const res = await fetch('/api/ollama/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, model })
        });

        const data = await res.json();
        document.getElementById('ollamaResponse').textContent =
          JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('ollamaResponse').textContent =
          'Erreur: ' + e.toString();
      }
    }

    refreshStatus();
  </script>
</body>
</html>
